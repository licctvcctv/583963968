import React from 'react';
import { KaliTerminal } from '../shared/Terminal';

// 四、详细设计说明
export const MA04_DetailDesign: React.FC = () => {
    return (
        <div className="page bg-white w-[210mm] min-h-[297mm] mx-auto shadow-lg mb-8 p-12 page-break">
            <h2 className="text-[18pt] font-hei mb-6 font-bold">四、详细设计说明</h2>

            <h3 className="text-[14pt] font-hei font-bold mt-6 mb-4">4.1 样本初步分析</h3>
            <p className="mb-4 indent-8 text-justify">
                在运行样本之前，首先进行静态初步分析，获取文件基本信息和字符串特征。
            </p>

            <KaliTerminal 
                cwd="~/malware"
                command="file update_service.exe"
                output="update_service.exe: PE32 executable (GUI) Intel 80386, for MS Windows"
            />
            <p className="text-center text-sm font-bold mb-4">图 4-1 文件类型识别</p>

            <KaliTerminal 
                cwd="~/malware"
                command="md5sum update_service.exe"
                output="a1b2c3d4e5f6789012345678abcdef01  update_service.exe"
            />
            <p className="text-center text-sm font-bold mb-4">图 4-2 计算文件哈希</p>

            <KaliTerminal 
                cwd="~/malware"
                command="strings update_service.exe | head -15"
                output={`!This program cannot be run in DOS mode.
.text
.rdata
.data
SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run
UpdateService
http://192.168.100.50:8443/beacon
AES-256-CBC
HKEY_CURRENT_USER
cmd.exe /c
powershell.exe -enc`}
            />
            <p className="text-center text-sm font-bold mb-4">图 4-3 提取可疑字符串</p>

            <h3 className="text-[14pt] font-hei font-bold mt-6 mb-4">4.2 C2通信协议分析</h3>
            <p className="mb-4 indent-8 text-justify">
                通过Wireshark捕获样本运行时的网络流量，分析C2通信协议特征：
            </p>

            <div className="bg-gray-100 p-4 rounded mb-4">
                <h4 className="font-bold mb-2">通信协议特征：</h4>
                <ul className="list-disc ml-6 space-y-1 text-sm">
                    <li><span className="font-bold">协议类型：</span>HTTPS (TCP 8443)</li>
                    <li><span className="font-bold">C2服务器：</span>192.168.100.50:8443</li>
                    <li><span className="font-bold">心跳间隔：</span>60秒</li>
                    <li><span className="font-bold">加密算法：</span>AES-256-CBC</li>
                    <li><span className="font-bold">数据格式：</span>Base64编码的JSON</li>
                </ul>
            </div>

            <h3 className="text-[14pt] font-hei font-bold mt-6 mb-4">4.3 加密算法还原</h3>
            <p className="mb-4 indent-8 text-justify">
                通过逆向分析，发现样本使用AES-256-CBC加密通信数据，密钥通过硬编码方式存储：
            </p>

            <div className="bg-gray-100 p-4 rounded font-mono text-xs mb-4">
                <pre>{`// 从样本中提取的加密参数
Key (32 bytes): 0x41 0x42 0x43 0x44 0x45 0x46 0x47 0x48
                0x49 0x4A 0x4B 0x4C 0x4D 0x4E 0x4F 0x50
                0x51 0x52 0x53 0x54 0x55 0x56 0x57 0x58
                0x59 0x5A 0x31 0x32 0x33 0x34 0x35 0x36

IV (16 bytes):  0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
                0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F

Key (ASCII): ABCDEFGHIJKLMNOPQRSTUVWXYZ123456`}</pre>
            </div>
            <p className="text-center text-sm font-bold mb-4">图 4-4 提取的加密密钥</p>

            <h3 className="text-[14pt] font-hei font-bold mt-6 mb-4">4.4 持久化机制分析</h3>
            <p className="mb-4 indent-8 text-justify">
                通过Ghidra逆向分析，发现样本使用以下持久化机制：
            </p>

            <table className="w-full border-collapse border border-gray-400 mb-4">
                <thead>
                    <tr className="bg-gray-100">
                        <th className="border border-gray-400 p-2">持久化方式</th>
                        <th className="border border-gray-400 p-2">位置/路径</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td className="border border-gray-400 p-2">注册表自启动</td>
                        <td className="border border-gray-400 p-2 font-mono text-xs">HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\UpdateService</td>
                    </tr>
                    <tr>
                        <td className="border border-gray-400 p-2">计划任务</td>
                        <td className="border border-gray-400 p-2 font-mono text-xs">\Microsoft\Windows\UpdateService\Check</td>
                    </tr>
                    <tr>
                        <td className="border border-gray-400 p-2">文件复制</td>
                        <td className="border border-gray-400 p-2 font-mono text-xs">%APPDATA%\Microsoft\UpdateService\svchost.exe</td>
                    </tr>
                </tbody>
            </table>
            <p className="text-center text-sm font-bold mb-4">表 4-1 持久化机制列表</p>
        </div>
    );
};
