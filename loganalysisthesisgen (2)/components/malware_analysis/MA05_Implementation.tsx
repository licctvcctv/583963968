import React from 'react';

// 五、系统实现（核心功能代码）
export const MA05_Implementation: React.FC = () => {
    const decryptScript = `#!/usr/bin/env python3
# c2_decrypt.py - C2通信解密脚本
# 用于解密捕获的恶意流量

from Crypto.Cipher import AES
from Crypto.Util.Padding import unpad
import base64
import json

# 从样本中提取的密钥
KEY = b'ABCDEFGHIJKLMNOPQRSTUVWXYZ123456'
IV = bytes([0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
            0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F])

def decrypt_c2_data(encrypted_b64):
    """解密C2通信数据"""
    try:
        encrypted = base64.b64decode(encrypted_b64)
        cipher = AES.new(KEY, AES.MODE_CBC, IV)
        decrypted = unpad(cipher.decrypt(encrypted), AES.block_size)
        return decrypted.decode('utf-8')
    except Exception as e:
        return f"Decryption failed: {e}"

def parse_c2_command(decrypted_json):
    """解析C2指令"""
    try:
        data = json.loads(decrypted_json)
        cmd_type = data.get('type', 'unknown')
        payload = data.get('payload', '')
        
        print(f"[*] Command Type: {cmd_type}")
        print(f"[*] Payload: {payload}")
        return data
    except json.JSONDecodeError:
        print(f"[!] Invalid JSON: {decrypted_json}")
        return None

if __name__ == "__main__":
    # 示例：解密捕获的C2数据
    sample_encrypted = "U2FsdGVkX1+vupppZksvRf5pq5g5XjFRIipRkwB0K1Y="
    
    print("[*] C2 Traffic Decryptor")
    print(f"[*] Encrypted: {sample_encrypted}")
    
    decrypted = decrypt_c2_data(sample_encrypted)
    print(f"[*] Decrypted: {decrypted}")`;

    const cleanupScript = `# cleanup_malware.ps1 - 恶意软件清除脚本
# 用于删除持久化注册表键值和恶意文件

Write-Host "[*] Malware Cleanup Script" -ForegroundColor Green
Write-Host "[*] Target: UpdateService RAT" -ForegroundColor Green

# 1. 删除注册表自启动项
Write-Host "[+] Removing registry persistence..." -ForegroundColor Yellow
$regPath = "HKCU:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run"
$regName = "UpdateService"

if (Get-ItemProperty -Path $regPath -Name $regName -ErrorAction SilentlyContinue) {
    Remove-ItemProperty -Path $regPath -Name $regName -Force
    Write-Host "[*] Registry key removed: $regPath\\$regName" -ForegroundColor Green
} else {
    Write-Host "[-] Registry key not found" -ForegroundColor Gray
}

# 2. 删除计划任务
Write-Host "[+] Removing scheduled task..." -ForegroundColor Yellow
$taskName = "\\Microsoft\\Windows\\UpdateService\\Check"

if (Get-ScheduledTask -TaskName "Check" -TaskPath "\\Microsoft\\Windows\\UpdateService\\" -ErrorAction SilentlyContinue) {
    Unregister-ScheduledTask -TaskName "Check" -TaskPath "\\Microsoft\\Windows\\UpdateService\\" -Confirm:$false
    Write-Host "[*] Scheduled task removed: $taskName" -ForegroundColor Green
} else {
    Write-Host "[-] Scheduled task not found" -ForegroundColor Gray
}

# 3. 删除恶意文件
Write-Host "[+] Removing malicious files..." -ForegroundColor Yellow
$malwarePath = "$env:APPDATA\\Microsoft\\UpdateService"

if (Test-Path $malwarePath) {
    Remove-Item -Path $malwarePath -Recurse -Force
    Write-Host "[*] Directory removed: $malwarePath" -ForegroundColor Green
} else {
    Write-Host "[-] Directory not found" -ForegroundColor Gray
}

# 4. 终止恶意进程
Write-Host "[+] Terminating malicious processes..." -ForegroundColor Yellow
$processes = @("svchost_fake", "update_service")

foreach ($proc in $processes) {
    $running = Get-Process -Name $proc -ErrorAction SilentlyContinue
    if ($running) {
        Stop-Process -Name $proc -Force
        Write-Host "[*] Process terminated: $proc" -ForegroundColor Green
    }
}

Write-Host "[*] Cleanup completed!" -ForegroundColor Green`;

    const suricataRules = `# suricata_rules.rules - 恶意流量检测规则
# 针对 UpdateService RAT 的检测规则

# 规则1: 检测C2心跳通信
alert tcp any any -> any 8443 (
    msg:"MALWARE UpdateService RAT C2 Beacon Detected";
    flow:established,to_server;
    content:"POST"; http_method;
    content:"/beacon"; http_uri;
    content:"User-Agent: Mozilla/5.0 UpdateService";
    classtype:trojan-activity;
    sid:1000001;
    rev:1;
)

# 规则2: 检测Base64编码的AES加密数据
alert tcp any any -> any 8443 (
    msg:"MALWARE UpdateService RAT Encrypted C2 Traffic";
    flow:established,to_server;
    content:"POST"; http_method;
    pcre:"/[A-Za-z0-9+\\/]{32,}={0,2}/";
    classtype:trojan-activity;
    sid:1000002;
    rev:1;
)

# 规则3: 检测命令执行响应
alert tcp any 8443 -> any any (
    msg:"MALWARE UpdateService RAT Command Response";
    flow:established,to_client;
    content:"200"; http_stat_code;
    content:"application/json"; http_header;
    pcre:"/(cmd|exec|shell|download)/i";
    classtype:trojan-activity;
    sid:1000003;
    rev:1;
)

# 规则4: 检测特征User-Agent
alert http any any -> any any (
    msg:"MALWARE UpdateService RAT User-Agent";
    http.user_agent; content:"UpdateService";
    classtype:trojan-activity;
    sid:1000004;
    rev:1;
)`;

    return (
        <>
            <div className="page bg-white w-[210mm] min-h-[297mm] mx-auto shadow-lg mb-8 p-12 page-break">
                <h2 className="text-[18pt] font-hei mb-6 font-bold">五、系统实现</h2>

                <h3 className="text-[14pt] font-hei font-bold mt-6 mb-4">5.1 C2通信解密脚本</h3>
                <p className="mb-4 indent-8 text-justify">
                    基于逆向分析获取的加密密钥，编写Python脚本解密捕获的C2通信数据：
                </p>
                <div className="bg-gray-100 p-4 rounded font-mono text-xs mb-4 overflow-x-auto">
                    <pre>{decryptScript}</pre>
                </div>
                <p className="text-center text-sm font-bold mb-4">代码 5-1 C2通信解密脚本 c2_decrypt.py</p>

                <h3 className="text-[14pt] font-hei font-bold mt-6 mb-4">5.2 恶意软件清除脚本</h3>
                <p className="mb-4 indent-8 text-justify">
                    编写PowerShell脚本，用于清除恶意软件的持久化机制：
                </p>
                <div className="bg-gray-100 p-4 rounded font-mono text-xs mb-4 overflow-x-auto">
                    <pre>{cleanupScript}</pre>
                </div>
                <p className="text-center text-sm font-bold mb-4">代码 5-2 恶意软件清除脚本 cleanup_malware.ps1</p>
            </div>

            <div className="page bg-white w-[210mm] min-h-[297mm] mx-auto shadow-lg mb-8 p-12 page-break">
                <h3 className="text-[14pt] font-hei font-bold mt-6 mb-4">5.3 Suricata检测规则</h3>
                <p className="mb-4 indent-8 text-justify">
                    基于流量特征编写Suricata规则，实现对该恶意样本流量的检测：
                </p>
                <div className="bg-gray-100 p-4 rounded font-mono text-xs mb-4 overflow-x-auto">
                    <pre>{suricataRules}</pre>
                </div>
                <p className="text-center text-sm font-bold mb-4">代码 5-3 Suricata检测规则 suricata_rules.rules</p>

                <h3 className="text-[14pt] font-hei font-bold mt-6 mb-4">5.4 规则说明</h3>
                <table className="w-full border-collapse border border-gray-400 mb-4">
                    <thead>
                        <tr className="bg-gray-100">
                            <th className="border border-gray-400 p-2">规则ID</th>
                            <th className="border border-gray-400 p-2">检测目标</th>
                            <th className="border border-gray-400 p-2">检测方法</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td className="border border-gray-400 p-2 text-center">1000001</td>
                            <td className="border border-gray-400 p-2">C2心跳通信</td>
                            <td className="border border-gray-400 p-2">检测/beacon URI和特征UA</td>
                        </tr>
                        <tr>
                            <td className="border border-gray-400 p-2 text-center">1000002</td>
                            <td className="border border-gray-400 p-2">加密数据传输</td>
                            <td className="border border-gray-400 p-2">正则匹配Base64编码数据</td>
                        </tr>
                        <tr>
                            <td className="border border-gray-400 p-2 text-center">1000003</td>
                            <td className="border border-gray-400 p-2">命令执行响应</td>
                            <td className="border border-gray-400 p-2">检测响应中的命令关键字</td>
                        </tr>
                        <tr>
                            <td className="border border-gray-400 p-2 text-center">1000004</td>
                            <td className="border border-gray-400 p-2">特征User-Agent</td>
                            <td className="border border-gray-400 p-2">检测UpdateService UA</td>
                        </tr>
                    </tbody>
                </table>
                <p className="text-center text-sm font-bold mb-4">表 5-1 检测规则说明</p>
            </div>
        </>
    );
};
